<!DOCTYPE html>
<html lang="ja" data-bs-theme="auto">
    <head>
        <meta charset="UTF-8">
        <meta name="google-site-verification" content="OC87FYYbTNU7c3Q1vn3qee5kXLtXMjotpx0iGK1ZPUU" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="/model/index/index.js"></script>
        <script src="/model/tips/tips.js"></script>
        <script src="/model/tips/cTips.js"></script>

        <div id="styleList"></div>
        <link href="/css/loading.css" rel="stylesheet">
        <div class="loading-container" id="loadingScreen">
            <div class="loading"></div>
        </div>
        <script src="/view/loading.js"></script>
        <title>MsQuic Setup - とあるペンギンの実験室</title>
    </head>
    <body>
        <div id="header-contents"></div>
        
            <main>
                <div class="row g-5 pt-3 mx-1">
                    <div class="col-md-8">
                        <h2 class="pt-4 mt-4 border-bottom fw-bold" id="article_top">
                            C/C++ Notes
                        </h2>
                        <article class="blog-post">
                            <h3 class="pt-4 mt-4 border-bottom fw-bold" id="msquic">
                                MsQuicのセットアップ (Linux用)
                            </h3>
                            <h4 class="pt-4 mt-4 border-bottom fw-bold">
                                CMakeのアップグレード(>= 3.16) 
                            </h4>
                            <h5 class="pt-4 fw-bold">
                                バージョン確認
                            </h5>
                            <p>
                                <div class="fw-bold">
                                    ターミナル
                                </div>
                                <pre><code class="language-bash">cmake --version</code></pre>
                            </p>
                            <h5 class="pt-4 fw-bold">
                                リポジトリの追加
                            </h5>
                            <p>
                                <div class="fw-bold">
                                    ターミナル
                                </div>
                                <pre><code class="language-bash">echo "deb http://deb.debian.org/debian bookworm-backports main contrib non-free" | sudo tee /etc/apt/sources.list.d/bookworm-backports.list</code></pre>
                            </p>
                            <h5 class="pt-4 fw-bold">
                                必要なパッケージをインストール
                            </h5>
                            <p>
                                <div class="fw-bold">
                                    ターミナル
                                </div>
                                <pre><code class="language-bash">sudo apt update
sudo apt install -t bookworm-backports cmake</code></pre>
                            </p>
                            <h4 class="pt-4 mt-4 border-bottom fw-bold">
                                MsQuicのインストール
                            </h4>
                            <h5 class="pt-4 fw-bold">
                                必要なパッケージをインストール
                            </h5>
                            <p>
                                <div class="fw-bold">
                                    ターミナル
                                </div>
                                <pre><code class="language-bash">sudo apt install -y git software-properties-common apt-transport-https curl libssl-dev libunwind-dev clang ninja-build libtool m4 autoconf</code></pre>
                            </p>
                            <h5 class="pt-4 fw-bold">
                                GitHubからダウンロード
                            </h5>
                            <p>
                                <div class="fw-bold">
                                    ターミナル
                                </div>
                                <pre><code class="language-bash">git clone https://github.com/microsoft/msquic.git
cd msquic/
git submodule update --init --recursive</code></pre>
                            </p>
                            <h5 class="pt-4 fw-bold">
                                ビルド & インストール
                            </h5>
                            <p>
                                <div class="fw-bold">
                                    ターミナル
                                </div>
                                <pre><code class="language-bash">mkdir build
cd build
QUIC_ENABLE_PREVIEW_FEATURES=1 cmake -B build -S .. -GNinja
cmake --build build
sudo cmake --install build
sudo ldconfig</code></pre>
                            </p>
                            <h5 class="pt-4 fw-bold">
                                インストール先
                            </h5>
                            <p>
                                <pre><code class="language-bash">-- Install configuration: "Release"
-- Installing: /usr/local/lib/libmsquic.so.2.6.0
-- Installing: /usr/local/lib/libmsquic.so.2
-- Installing: /usr/local/lib/libmsquic.so
-- Installing: /usr/local/lib/libmsquic_platform.a
-- Installing: /usr/local/include/msquic.h
-- Installing: /usr/local/include/msquic.hpp
-- Installing: /usr/local/include/msquic_fuzz.h
-- Installing: /usr/local/include/msquic_posix.h
-- Installing: /usr/local/include/msquic_winkernel.h
-- Installing: /usr/local/include/msquic_winuser.h
-- Installing: /usr/local/include/msquichelper.h
-- Installing: /usr/local/include/msquicp.h
-- Installing: /usr/local/include/quic_cert.h
-- Installing: /usr/local/include/quic_crypt.h
-- Installing: /usr/local/include/quic_datapath.h
-- Installing: /usr/local/include/quic_driver_helpers.h
-- Installing: /usr/local/include/quic_hashtable.h
-- Installing: /usr/local/include/quic_pcp.h
-- Installing: /usr/local/include/quic_platform.h
-- Installing: /usr/local/include/quic_platform_posix.h
-- Installing: /usr/local/include/quic_platform_winkernel.h
-- Installing: /usr/local/include/quic_platform_winuser.h
-- Installing: /usr/local/include/quic_sal_stub.h
-- Installing: /usr/local/include/quic_storage.h
-- Installing: /usr/local/include/quic_tls.h
-- Installing: /usr/local/include/quic_toeplitz.h
-- Installing: /usr/local/include/quic_trace.h
-- Installing: /usr/local/include/quic_trace_manifested_etw.h
-- Installing: /usr/local/include/quic_var_int.h
-- Installing: /usr/local/include/quic_versions.h
-- Installing: /usr/local/share/msquic/msquic-config.cmake
-- Installing: /usr/local/share/msquic/msquic.cmake
-- Installing: /usr/local/share/msquic/msquic-release.cmake</code></pre>
                            </p>
                            <p>
                                <pre><code class="language-bash">cat ファイルパス | grep [オプション -A : 後ろ -B : 前 -C : 前後] [行数] [検索文字列]</code></pre>でファイルの中身を検索出来る
                            </p>
                        </article>

                        <article class="blog-post">
                            <h3 class="pt-4 mt-4 border-bottom fw-bold" id="msquic-win">
                                MsQuicのセットアップ (Windows用)
                            </h3>
                            <h4 class="pt-4 mt-4 border-bottom fw-bold">
                                Visual Studioをインストールする
                            </h4>
                            <a href ="https://visualstudio.microsoft.com/ja/"> 
                                <img src="/img/VisualStudio-Dark.svg" width = "100"/>
                            </a>
                            <br>
                            <a href ="https://visualstudio.microsoft.com/ja/"> 
                                <b>Download</b>
                            </a>
                            <h4 class="pt-4 mt-4 border-bottom fw-bold">
                                CMakeをインストールする
                            </h4>
                            <p>
                                &emsp;最新版をインストール
                            </p>
                            <a href ="https://cmake.org/download/"> 
                                <img src="/img/CMake-Dark.svg" width = "100"/>
                            </a>
                            <br>
                            <a href ="https://cmake.org/download/"> 
                                <b>Download</b>
                            </a>
                            <p>
                                &emsp;Windows x64 Installerを選択 (インストール後パスが通っていることを確認)
                            </p>
                            <h4 class="pt-4 mt-4 border-bottom fw-bold">
                                MsQuicをビルド
                            </h4>
                            <p>
                                <div class="fw-bold">
                                    コマンドプロンプト
                                </div>
                                <pre><code class="language-bash">cd C:/
mkdir Programs
git clone https://github.com/microsoft/msquic.git
cd msquic
git submodule update --init --recursive
mkdir build
cd build
cmake -B build -S .. -G "Visual Studio 17 2022" -A x64 -DQUIC_TLS_LIB=schannel
cmake --build build</code></pre>
                            </p>
                            <h4 class="pt-4 mt-4 border-bottom fw-bold">
                                ライブラリ
                            </h4>
                            <h5 class="pt-4 fw-bold">
                                ライブラリのパス
                            </h5>
                            <code>C:/Programs/msquic/build/build/bin/Debug/msquic.dll</code>
                            <h5 class="pt-4 fw-bold">
                                ヘッダのパス
                            </h5>
                            <code>C:/Programs/msquic/src/inc/msquic.h</code>
                            
                            <h4 class="pt-4 mt-4 border-bottom fw-bold">
                                Visual Studio の設定
                            </h4>
                            <h5 class="pt-4 fw-bold">
                                ヘッダーファイルのインクルードパスを設定
                            </h5>
                            <p>
                                [プロジェクト] → [プロパティ]→[構成プロパティ] → [VC++ ディレクトリ] → [全般] → [外部インクルードディレクトリ]
                            </p>
                            <code>C:/Programs/msquic/src/inc</code>
                            <h5 class="pt-4 fw-bold">
                                ライブラリディレクトリの追加
                            </h5>
                            <p>
                                [プロジェクト] → [プロパティ]→[構成プロパティ] → [リンカー] → [全般] → [追加のライブラリディレクトリ]
                            </p>
                            <code>C:/Programs/msquic/build/build/bin/Debug</code>
                            <h5 class="pt-4 fw-bold">
                                リンクするライブラリの指定
                            </h5>
                            <p>
                                [プロジェクト] → [プロパティ]→[構成プロパティ] → [リンカー] → [入力] → [追加の依存ファイル]
                            </p>
                            <code>msquic.lib</code>
                            <h5 class="pt-4 fw-bold">
                                環境変数にPATHを追加
                            </h5>
                            <code>C:\Programs\msquic\build\build\bin\Debug</code>

                        </article>

                        <article class="blog-post">
                            <h4 class="pt-4 mt-4 border-bottom fw-bold" id="sample">
                                サンプルコード
                            </h4>
                            <p>
                                <div class="fw-bold">
                                    ヘッダファイル (QUICStart.cpp)
                                </div>
                                <pre><code class="language-cpp">#define _CRT_SECURE_NO_WARNINGS //SDLチェック無効

#include &lt;cstddef&gt;
#include &lt;limits&gt;
#include &lt;climits&gt;
#include &lt;cfloat&gt;
#include &lt;cstdint&gt;
#include &lt;cstdlib&gt;
#include &lt;new&gt;
#include &lt;typeinfo&gt;
#include &lt;exception&gt;
#include &lt;initializer_list&gt;
#include &lt;cstdalign&gt;
#include &lt;stdexcept&gt;
#include &lt;cassert&gt;
#include &lt;cerrno&gt;
#include &lt;system_error&gt;
#include &lt;string&gt;

#if __has_include(&lt;string_view&gt;)
#   include &lt;string_view&gt;
#endif

#include &lt;array&gt;
#include &lt;deque&gt;
#include &lt;forward_list&gt;
#include &lt;list&gt;
#include &lt;vector&gt;
#include &lt;map&gt;
#include &lt;set&gt;
#include &lt;unordered_map&gt;
#include &lt;unordered_set&gt;
#include &lt;queue&gt;
#include &lt;stack&gt;
#include &lt;iterator&gt;
#include &lt;algorithm&gt;
#include &lt;cfenv&gt;
#include &lt;random&gt;
#include &lt;numeric&gt;
#include &lt;iosfwd&gt;
#include &lt;iostream&gt;
#include &lt;ios&gt;
#include &lt;streambuf&gt;
#include &lt;istream&gt;
#include &lt;ostream&gt;
#include &lt;iomanip&gt;
#include &lt;sstream&gt;
#include &lt;fstream&gt;

#if __has_include(&lt;filesystem&gt;)
    # include &lt;filesystem&gt;
#endif

#include &lt;cstdio&gt;
#include &lt;cinttypes&gt;

#include &lt;regex&gt;
#include &lt;atomic&gt;
#include &lt;thread&gt;
#include &lt;mutex&gt;
#include &lt;shared_mutex&gt;
#include &lt;condition_variable&gt;
#include &lt;future&gt;
#include &lt;cstring&gt;       
#include &lt;tuple&gt;   
#include &lt;ctime&gt;
#include &lt;chrono&gt;

#define _USE_MATH_DEFINES //数値演算定数を定義
#include &lt;cmath&gt;

#define OPEN_PROCESS_TOKEN (TOKEN_ADJUST_PRIVILEGES|TOKEN_QUERY) // アクセス権の定数

#ifdef __linux__ 
    //linux code
    #include &lt;arpa/inet.h&gt;
    #include &lt;sys/socket.h&gt;
    #include &lt;unistd.h&gt;

#elif _WIN32
    // windows code
    #include &lt;direct.h&gt;
    #include &lt;tchar.h&gt;
    #include &lt;WinSock2.h&gt;
    #include &lt;ws2tcpip.h&gt;
    #include &lt;windowsx.h&gt;
    #include &lt;Windows.h&gt;
    //#include &lt;shellapi.h&gt;
    #pragma comment(lib, "ws2_32.lib")
    #pragma warning(disable:4996)

#else

#endif


#if __has_include(&lt;msquic.h&gt;)
    #include &lt;msquic.h&gt;
    class QUICStart{
        protected:
            QUIC_API_TABLE* MsQuic;
            QUIC_STATUS status;
            HQUIC Listener                                  = NULL;
            HQUIC Configuration                             = NULL;
            HQUIC Registration                              = NULL;
            HQUIC QUICConnection                            = NULL;
            QUIC_SETTINGS Settings                          = {0};
            QUIC_ADDR Address                               = {0};
            QUIC_BUFFER AlpnBuffer;
            QUIC_REGISTRATION_CONFIG RegistrationConfig;            // 登録設定
            QUIC_CERTIFICATE_FILE CertificateConfig;                // 証明書と秘密鍵の設定
            QUIC_CREDENTIAL_CONFIG CredConfig;
            QUIC_BUFFER* Buffer;
            bool isServer                                   = true;
            std::string ipv4;
            int port;
            std::vector&lt;uint8_t&gt; recvData;
            std::string sendData                            = "";
            bool debug                                      = false;
            bool retry                                      = false;

            _IRQL_requires_max_(DISPATCH_LEVEL) 
            _Function_class_(QUIC_LISTENER_CALLBACK) 
            static QUIC_STATUS QUIC_API ListenerCallback( // ListenerCallback関数
                _In_ HQUIC Listener,
                _In_opt_ void* Context,
                _Inout_ QUIC_LISTENER_EVENT* Event
            ) {
                QUICStart* self = reinterpret_cast&lt;QUICStart*&gt;(Context);
                switch (Event-&gt;Type) { // イベントを重複定義しないよう switch case文を使う
                    case QUIC_LISTENER_EVENT_NEW_CONNECTION:
                        if (self-&gt;debug) printf("[ListenerCallback] NEW_CONNECTION\n");
                        self-&gt;QUICConnection = Event-&gt;NEW_CONNECTION.Connection;
                        self-&gt;MsQuic-&gt;SetCallbackHandler(self-&gt;QUICConnection, (void*)ConnectionCallback, self);
                        self-&gt;status = self-&gt;MsQuic-&gt;ConnectionSetConfiguration(self-&gt;QUICConnection, self-&gt;Configuration);
                        if (QUIC_FAILED(self-&gt;status)) {
                            printf("[FAILED] ConnectionSetConfiguration: 0x%x\n", self-&gt;status);
                            self-&gt;MsQuic-&gt;ConnectionClose(self-&gt;QUICConnection);
                        }
                        break;

                    default:
                        if (self-&gt;debug) printf("[ListenerCallback] Listener event type: 0x%X\n", Event-&gt;Type);
                        break;
                }
                return QUIC_STATUS_SUCCESS;
            }

            
            _IRQL_requires_max_(DISPATCH_LEVEL)
            _Function_class_(QUIC_CONNECTION_CALLBACK)
            QUIC_STATUS
            QUIC_API
            static ConnectionCallback( // ConnectionCallback関数
                _In_ HQUIC Connection,
                _In_opt_ void* Context,
                _Inout_ QUIC_CONNECTION_EVENT* Event
            ) {
                HQUIC Stream;
                QUICStart* self = reinterpret_cast&lt;QUICStart*&gt;(Context);
                switch (Event-&gt;Type) {
                    case QUIC_CONNECTION_EVENT_CONNECTED:
                        if (self-&gt;debug) printf("[ConnectionCallback] QUIC_CONNECTION_EVENT_CONNECTED\n");
                        if(!self-&gt;isServer){
                            self-&gt;status = self-&gt;MsQuic-&gt;StreamOpen(// ストリームを作成
                                Connection,
                                QUIC_STREAM_OPEN_FLAG_NONE,
                                (QUIC_STREAM_CALLBACK_HANDLER)QUICStart::StreamCallback,
                                Context,
                                &Stream
                            );
                            if (QUIC_SUCCEEDED(self-&gt;status)) {
                                self-&gt;MsQuic-&gt;StreamStart(Stream, QUIC_STREAM_START_FLAG_IMMEDIATE);
                            
                            } else {
                                printf("[FAILED] StreamOpen : 0x%x\n", self-&gt;status);
                                // ストリーム作成失敗時に Connection を閉じる処理を追加しても良い
                                self-&gt;MsQuic-&gt;ConnectionShutdown(Connection, QUIC_CONNECTION_SHUTDOWN_FLAG_NONE, 0);
                            }
                        }
                        break;
                    case QUIC_CONNECTION_EVENT_SHUTDOWN_INITIATED_BY_TRANSPORT:
                        if (self-&gt;debug) printf("[ConnectionCallback] QUIC_CONNECTION_EVENT_SHUTDOWN_INITIATED_BY_TRANSPORT\n");
                        self-&gt;MsQuic-&gt;ConnectionClose(Connection);
                        break;
                    case QUIC_CONNECTION_EVENT_SHUTDOWN_COMPLETE:
                        if (self-&gt;debug) printf("[ConnectionCallback] QUIC_CONNECTION_EVENT_SHUTDOWN_COMPLETE\n");
                        self-&gt;MsQuic-&gt;ConnectionClose(Connection);
                        break;
                    case QUIC_CONNECTION_EVENT_PEER_STREAM_STARTED:
                        if (self-&gt;debug) printf("[ConnectionCallback] QUIC_CONNECTION_EVENT_PEER_STREAM_STARTED\n");
                        if(self-&gt;isServer){
                            Stream = Event-&gt;PEER_STREAM_STARTED.Stream;
                            self-&gt;MsQuic-&gt;SetCallbackHandler(Stream, (void*)self-&gt;StreamCallback, self);
                            self-&gt;MsQuic-&gt;StreamReceiveSetEnabled(Stream, TRUE);
                        }
                        break;
                    
                    case QUIC_CONNECTION_EVENT_PEER_NEEDS_STREAMS:
                        if (self-&gt;debug) printf("[ConnectionCallback] QUIC_CONNECTION_EVENT_PEER_NEEDS_STREAMS\n");
                        break;
                    
                    default:
                        if (self-&gt;debug) printf("[ConnectionCallback] Connection event type: 0x%X\n", Event-&gt;Type);
                        break;
                }
                return QUIC_STATUS_SUCCESS;
            }

            _IRQL_requires_max_(DISPATCH_LEVEL)
            _Function_class_(QUIC_STREAM_CALLBACK)
            QUIC_STATUS
            QUIC_API
            static StreamCallback( // StreamCallback関数
                _In_ HQUIC Stream,
                _In_opt_ void* Context,
                _Inout_ QUIC_STREAM_EVENT* Event
            ) {
                size_t msgLen;
                uint8_t* message; 
                QUICStart* self = reinterpret_cast&lt;QUICStart*&gt;(Context);
                switch (Event-&gt;Type) {
                    case QUIC_STREAM_EVENT_START_COMPLETE:
                        if (self-&gt;debug) printf("[StreamCallback] QUIC_STREAM_EVENT_START_COMPLETE\n");
                        if (self-&gt;sendData != ""){
                            msgLen                      = self-&gt;sendData.length();
                            message                     = (uint8_t*)malloc(msgLen + 1);
                            if (!message) {
                                printf("[FAILED] malloc\n");
                                return QUIC_STATUS_OUT_OF_MEMORY;
                            }
                            memcpy(message, self-&gt;sendData.c_str(), msgLen + 1);
                            self-&gt;Buffer                = (QUIC_BUFFER*)malloc(sizeof(QUIC_BUFFER));
                            if (!self-&gt;Buffer) {
                                printf("[FAILED] malloc\n");
                                free(message);
                                return QUIC_STATUS_OUT_OF_MEMORY;
                            }
                            self-&gt;Buffer-&gt;Buffer        = (uint8_t*)message;
                            self-&gt;Buffer-&gt;Length        = (uint32_t)msgLen;
                            self-&gt;MsQuic-&gt;StreamSend(
                                Stream, 
                                self-&gt;Buffer, 
                                1, 
                                QUIC_SEND_FLAG_START | QUIC_SEND_FLAG_FIN, 
                                self-&gt;Buffer
                            );
                            //MsQuic-&gt;StreamSend(Stream, NULL, 0, QUIC_SEND_FLAG_FIN, NULL);
                            if (self-&gt;debug) printf("[StreamCallback] StreamSend : %s\n", self-&gt;sendData.c_str());
                        }
                        break;

                    case QUIC_STREAM_EVENT_SEND_COMPLETE:
                        if (self-&gt;debug) printf("[StreamCallback] QUIC_STREAM_EVENT_SEND_COMPLETE\n");
                        self-&gt;Buffer = (QUIC_BUFFER*)Event-&gt;SEND_COMPLETE.ClientContext;
                        if (self-&gt;Buffer) {
                            free(self-&gt;Buffer-&gt;Buffer); // message の解放
                            free(self-&gt;Buffer);         // Buffer の解放
                        }
                        break;

                    case QUIC_STREAM_EVENT_RECEIVE:
                        if (self-&gt;debug) printf("[StreamCallback] QUIC_STREAM_EVENT_RECEIVE\n");
                        for (uint32_t i = 0; i &lt; Event-&gt;RECEIVE.BufferCount; ++i) {
                            message             = static_cast&lt;uint8_t*&gt;(Event-&gt;RECEIVE.Buffers[i].Buffer);
                            msgLen              = static_cast&lt;size_t&gt;(Event-&gt;RECEIVE.Buffers[i].Length);

                            self-&gt;recvData.insert(self-&gt;recvData.end(), message, message + msgLen);
                        }
                        self-&gt;MsQuic-&gt;StreamReceiveComplete(Stream, Event-&gt;RECEIVE.TotalBufferLength);
                        break;

                    case QUIC_STREAM_EVENT_PEER_SEND_SHUTDOWN:
                        if (self-&gt;debug) printf("[StreamCallback] QUIC_STREAM_EVENT_PEER_SEND_SHUTDOWN\n");
                        self-&gt;MsQuic-&gt;StreamShutdown(Stream, QUIC_STREAM_SHUTDOWN_FLAG_NONE, 0);
                        break;
                    case QUIC_STREAM_EVENT_SHUTDOWN_COMPLETE:
                        if (self-&gt;debug) printf("[StreamCallback] QUIC_STREAM_EVENT_SHUTDOWN_COMPLETE\n");
                        self-&gt;MsQuic-&gt;StreamClose(Stream);
                        break;
                    
                    
                    default:
                        if (self-&gt;debug) printf("[StreamCallback] Stream event type: 0x%X\n", Event-&gt;Type);
                        break;
                }
                return QUIC_STATUS_SUCCESS;
            }
        
        public:
            QUICStart(
                std::string serverIPv4                          = "127.0.0.1",
                int serverPort                                  = 9999,
                std::string appName                             = "QUICApplication",
                std::string alpn                                = "echo", 
                bool isServer                                   = true,
                std::string certFile                            = "certificate.crt",
                std::string keyFile                             = "private.key", 
                int streamCount                                 = 5,
                bool debug                                      = false
            ) { 
                this-&gt;ipv4                                      = serverIPv4;
                this-&gt;port                                      = serverPort;
                this-&gt;isServer                                  = isServer;
                this-&gt;debug                                     = debug;
                this-&gt;RegistrationConfig.ExecutionProfile       = QUIC_EXECUTION_PROFILE_LOW_LATENCY;
                this-&gt;RegistrationConfig.AppName                = appName.c_str();

                const char* alpnString                          = alpn.c_str();

                this-&gt;AlpnBuffer.Buffer                         = (uint8_t*)alpnString;
                this-&gt;AlpnBuffer.Length                         = (uint32_t)strlen(alpnString);

                this-&gt;Settings.IsSet.PeerBidiStreamCount        = TRUE;
                this-&gt;Settings.PeerBidiStreamCount              = streamCount; // 双方向ストリーム数
                this-&gt;Settings.IsSet.PeerUnidiStreamCount       = TRUE;
                this-&gt;Settings.PeerUnidiStreamCount             = 0;

                // 接続のセキュリティ設定
                memset(&this-&gt;CredConfig, 0, sizeof(this-&gt;CredConfig));
                if(this-&gt;isServer){
                    this-&gt;CertificateConfig.CertificateFile     = certFile.c_str();
                    this-&gt;CertificateConfig.PrivateKeyFile      = keyFile.c_str();
                    this-&gt;CredConfig.Flags                      = QUIC_CREDENTIAL_FLAG_NONE;
                    this-&gt;CredConfig.Type                       = QUIC_CREDENTIAL_TYPE_CERTIFICATE_FILE;
                    this-&gt;CredConfig.CertificateFile            = &this-&gt;CertificateConfig;
                }
                else{
                    this-&gt;CredConfig.Flags                      = (
                        QUIC_CREDENTIAL_FLAG_CLIENT | 
                        QUIC_CREDENTIAL_FLAG_NO_CERTIFICATE_VALIDATION
                    );

                }

                QuicAddrSetFamily(&this-&gt;Address, QUIC_ADDRESS_FAMILY_INET);
                QuicAddrSetPort(&this-&gt;Address, this-&gt;port);
                this-&gt;Address.Ipv4.sin_addr.s_addr              = inet_addr(this-&gt;ipv4.c_str()); // IPアドレスを直接設定
            }

            int connection_start(){
                if (!this-&gt;retry) {
                    this-&gt;status        = MsQuicOpenVersion(QUIC_API_VERSION_2, (const void**)&this-&gt;MsQuic);
                    if (QUIC_FAILED(this-&gt;status)) {
                        printf("[FAILED] MsQuicOpen : 0x%x\n", this-&gt;status);
                        return 1;
                    }

                    this-&gt;status        = this-&gt;MsQuic-&gt;RegistrationOpen(&this-&gt;RegistrationConfig, &this-&gt;Registration);
                    if (QUIC_FAILED(this-&gt;status)) {
                        printf("[FAILED] RegistrationOpen : 0x%x\n", this-&gt;status);
                        this-&gt;clear();
                        return 1;
                    }

                    this-&gt;status        = this-&gt;MsQuic-&gt;ConfigurationOpen(
                        this-&gt;Registration,
                        &this-&gt;AlpnBuffer,
                        1, // BufferCount
                        &this-&gt;Settings,
                        sizeof(this-&gt;Settings),
                        NULL,
                        &this-&gt;Configuration
                    );

                    if (QUIC_FAILED(this-&gt;status)) {
                        printf("[FAILED] ConfigurationOpen : 0x%x\n", this-&gt;status);
                        this-&gt;MsQuic-&gt;RegistrationClose(this-&gt;Registration);
                        this-&gt;clear();
                        return 1;
                    }

                    this-&gt;status        = this-&gt;MsQuic-&gt;ConfigurationLoadCredential(
                        this-&gt;Configuration, 
                        &this-&gt;CredConfig
                    );

                    if (QUIC_FAILED(this-&gt;status)) {
                        printf("[FAILED] ConfigurationLoadCredential : 0x%x\n", this-&gt;status);
                        this-&gt;clear();
                        return 1;
                    }
                }
                if(this-&gt;isServer){
                    this-&gt;status    = this-&gt;MsQuic-&gt;ListenerOpen(
                        this-&gt;Registration, 
                        this-&gt;ListenerCallback, 
                        this, 
                        &this-&gt;Listener
                    );

                    if (QUIC_FAILED(this-&gt;status)) {
                        printf("[FAILED] ListenerOpen : 0x%x\n", this-&gt;status);
                        this-&gt;clear();
                        return 1;
                    }
                    
                    this-&gt;status    = this-&gt;MsQuic-&gt;ListenerStart(
                        this-&gt;Listener, 
                        &this-&gt;AlpnBuffer, 
                        1, 
                        &this-&gt;Address
                    );

                    if (QUIC_FAILED(this-&gt;status)) {
                        printf("[FAILED] ListenerStart : 0x%x\n", this-&gt;status);
                        this-&gt;clear();
                        return 1;
                    }
                
                }
                else{
                    this-&gt;status    = this-&gt;MsQuic-&gt;ConnectionOpen(
                        this-&gt;Registration, 
                        this-&gt;ConnectionCallback, 
                        this, 
                        &this-&gt;QUICConnection
                    );

                    if (QUIC_FAILED(this-&gt;status)) {
                        printf("[FAILED] ConnectionOpen : 0x%x\n", this-&gt;status);
                        this-&gt;clear();
                        return 1;
                    }
                
                    // 接続を開始
                    this-&gt;status    = this-&gt;MsQuic-&gt;ConnectionStart(
                        this-&gt;QUICConnection, 
                        this-&gt;Configuration, 
                        QUIC_ADDRESS_FAMILY_UNSPEC, 
                        this-&gt;ipv4.c_str(), 
                        this-&gt;port
                    );

                    if (QUIC_FAILED(this-&gt;status)) {
                        printf("[FAILED] ConnectionStart : 0x%x\n", this-&gt;status);
                        this-&gt;clear();
                        return 1;
                    }
                }
                if(this-&gt;debug) printf("[CONNECTED] %s : %d\n", this-&gt;ipv4.c_str(), this-&gt;port);
                return 0;
            }

            ~QUICStart(){
                this-&gt;clear();
            }

            void send_data_set(std::string sendData = "Hello QUIC World!!"){
                this-&gt;sendData = sendData;
            }

            void disp_recv_data(){
                std::string data(this-&gt;recvData.begin(), this-&gt;recvData.end());
                printf("[RECV] %s\n", data.c_str());
                this-&gt;recvData.clear();
            }

            void clear(bool retry = false){
                this-&gt;retry = retry;
                this-&gt;recvData.clear();
                if (this-&gt;Listener != NULL) {
                    this-&gt;MsQuic-&gt;ListenerClose(this-&gt;Listener);
                    this-&gt;Listener = NULL;
                }
                if (this-&gt;QUICConnection    != NULL) {
                    this-&gt;MsQuic-&gt;ConnectionClose(this-&gt;QUICConnection);
                    this-&gt;QUICConnection    = NULL;
                }
                if (!this-&gt;retry) {
                    if (this-&gt;Configuration     != NULL) {
                        this-&gt;MsQuic-&gt;ConfigurationClose(this-&gt;Configuration);
                        this-&gt;Configuration     = NULL;
                    }
                    if (this-&gt;Registration      != NULL) {
                        this-&gt;MsQuic-&gt;RegistrationClose(this-&gt;Registration);
                        this-&gt;Registration      = NULL;
                    }
                    if (this-&gt;MsQuic            != NULL) {
                        MsQuicClose(this-&gt;MsQuic);
                        this-&gt;MsQuic            = NULL;
                    }
                }
                
            }

    };
#endif</code></pre>
                            </p>
                            <p>
                                <div class="fw-bold">
                                    クライアントサンプルコード (quic_sample_client.cpp)
                                </div>
                                <pre><code class="language-cpp">#include "QUICStart.cpp"
int main(int argc, char** argv){
    QUICStart quic = QUICStart(
        "192.168.10.64",
        9999,
        "QUICApplication",
        "echo", 
        false,
        "certificate.crt",
        "private.key", 
        5,
        true
    );
    quic.send_data_set("Hello !!");
    quic.connection_start();
    getchar();
    quic.clear(true);
    quic.send_data_set("World !!");
    quic.connection_start();
    getchar();
    return 0;
}</code></pre>
                            </p>
                            <p>
                                <div class="fw-bold">
                                    GCCビルド (Linux)
                                </div>
                                <pre><code class="language-bash">g++ -I /usr/local/include -L /usr/local/lib -g  quic_sample_client.cpp -lmsquic -lssl -lcrypto -ldl -lpthread -lrt -o quic_sample_client.exe</code></pre>
                            </p>

                            <p>
                                <div class="fw-bold">
                                    サーバサンプルコード (quic_sample_server.cpp)
                                </div>
                                <pre><code class="language-cpp">#include "QUICStart.cpp"
int main(int argc, char** argv){
    QUICStart quic = QUICStart(
        "192.168.10.64",
        9999,
        "QUICApplication",
        "echo", 
        true,
        "certificate.crt",
        "private.key", 
        5,
        true
    );
    quic.connection_start();
    getchar();
    quic.disp_recv_data();
    quic.clear(true);
    printf("再受信するには<ENTER>を押してください...");
    getchar();
    quic.connection_start();
    getchar();
    quic.disp_recv_data();
    getchar();
    return 0;
}</code></pre>
                            </p>
                            <p>
                                <div class="fw-bold">
                                    GCCビルド (Linux)
                                </div>
                                <pre><code class="language-bash">g++ -I /usr/local/include -L /usr/local/lib -g  quic_sample_server.cpp -lmsquic -lssl -lcrypto -ldl -lpthread -lrt -o quic_sample_server.exe</code></pre>
                            </p>

                        </article>
                    
                    </div>
                    <div class="col-md-4">
                        <div class="position-sticky" style="top: 2rem;">
                            <div class="p-4">
                                <h4 class="fst-italic border-bottom">References</h4>
                                <blockquote cite="https://github.com/microsoft/msquic">
                                    <a href="https://github.com/microsoft/msquic">
                                        MsQuic
                                    </a>
                                </blockquote>
                            </div>

                            <div class="p-4">
                                <h4 class="fst-italic border-bottom">Table of Contents</h4>
                                <ol class="list-unstyled mb-0">
                                    <li>
                                        <a href="#article_top">Top</a>
                                    </li>
                                    <li>
                                        <a href="#msquic">MsQuicのセットアップ (Linux用)</a>
                                    </li>
                                    <li>
                                        <a href="#msquic-win">MsQuicのセットアップ (Windows用)</a>
                                    </li>
                                    <li>
                                        <a href="#sample">サンプルコード</a>
                                    </li>
                                    
                                </ol>
                            </div>

                            <div id="tips"></div>
                        </div>
                    </div>
                </div>
            
            </main>
    </body>
    <footer class="container border-top"> <!-- FOOTER -->
        <div id="pagination"></div>
        <div id="footer-contents"></div>
        <script src="/view/bootstrap.bundle.min.js"></script>
        <script src="/view/search.js"></script>
        <script src="/view/embeddedHTML.js"></script>
        <script src="/view/highlight.min.js"></script>
        <script src="/view/activenav.js"></script>
        <script src="/view/tips/tips.js"></script>
        <script src="/view/createTable.js"></script>
        <script src="/view/pagination.js"></script>
        <script>
            hljs.highlightAll();
            embedded_html("/template/styleConfig.html", "styleList");
            embedded_html("/template/header.html", "header-contents");
            embedded_html("/template/footer.html", "footer-contents");
            window.addEventListener("load", active_nav("tipsIndex"));
            new TipsView(tipsModel, "tips", "tips", ["linuxTip", "serverTip", "windowsTip"]);
            new Pagination(2, cppModel.page, "pagination");
        </script>
    </footer>
</html>
